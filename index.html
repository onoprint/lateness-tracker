<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Lateness Tracker</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div id="app">
        <div style="padding:40px;text-align:center;">
            <h1>üìö Lateness Tracker</h1>
            <p>Loading...</p>
        </div>
    </div>
    
    <script>
    // Error handler - wrap everything
    (function() {
        window.onerror = function(msg, url, line, col, error) {
            document.getElementById('app').innerHTML = 
                '<div style="padding:20px;color:red;background:#fee;"><h2>Error</h2><p>' + msg + '</p><pre>Line: ' + line + '</pre></div>';
            return true;
        };
    })();
    </script>
    
    <script>
(()=>{var m=class{constructor(t){this.storage=t,this.classes=[]}async load(){this.classes=this.storage.get("classes",[])}save(){this.storage.set("classes",this.classes)}getAll(){return[...this.classes]}getById(t){return this.classes.find(e=>e.id===t)||null}add(t,e={}){let s={id:this.generateId(),name:t,schedule:e||this.defaultSchedule(),createdAt:new Date().toISOString()};return this.classes.push(s),this.save(),s}update(t,e){let s=this.classes.findIndex(a=>a.id===t);return s!==-1?(this.classes[s]={...this.classes[s],...e},this.save(),this.classes[s]):null}delete(t){this.classes=this.classes.filter(e=>e.id!==t),this.save()}getScheduleForDay(t,e){let s=this.getById(t);if(!s)return null;let i=["sunday","monday","tuesday","wednesday","thursday","friday","saturday"][e];return s.schedule[i]||null}defaultSchedule(){return{monday:{enabled:!0,startTime:"12:30",endTime:"14:20"},tuesday:{enabled:!0,startTime:"12:30",endTime:"14:20"},wednesday:{enabled:!0,startTime:"12:30",endTime:"14:20"},thursday:{enabled:!0,startTime:"12:30",endTime:"14:20"},friday:{enabled:!0,startTime:"12:30",endTime:"14:20"},saturday:{enabled:!0,startTime:"12:30",endTime:"14:20"},sunday:{enabled:!1}}}generateId(){return"cls_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}};var g=class{constructor(t){this.storage=t,this.students=[]}async load(){this.students=this.storage.get("students",[])}save(){this.storage.set("students",this.students)}getAll(){return[...this.students]}getByClass(t){return this.students.filter(e=>e.classId===t)}getById(t){return this.students.find(e=>e.id===t)||null}add(t,e,s=null){let a={id:this.generateId(),name:t.trim(),classId:e,photoUrl:s,createdAt:new Date().toISOString()};return this.students.push(a),this.save(),a}update(t,e){let s=this.students.findIndex(a=>a.id===t);return s!==-1?(this.students[s]={...this.students[s],...e},this.save(),this.students[s]):null}delete(t){this.students=this.students.filter(e=>e.id!==t),this.save()}importFromCSV(t,e){let s=t.trim().split(`
),a={success:!0,imported:0,errors:[]},i=s[0].toLowerCase().includes("name")?1:0;for(let n=i;n<s.length;n++){let r=s[n].trim();if(!r)continue;let d=r.split(",").map(u=>u.trim()),o=d[0],l=d[1]||null;o?(this.add(o,e,l),a.imported++):a.errors.push("Line "+(n+1)+": Empty name")}return a}getSortedByName(t){return this.getByClass(t).sort((e,s)=>e.name.localeCompare(s.name))}generateId(){return"stu_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}};var v=class{constructor(t,e){this.storage=t,this.classManager=e,this.arrivals=[]}async load(){this.arrivals=this.storage.get("arrivals",[])}save(){this.storage.set("arrivals",this.arrivals)}getAll(){return[...this.arrivals]}getByDate(t){return this.arrivals.filter(e=>e.date===t)}getByClassAndDate(t,e){return this.arrivals.filter(s=>s.classId===t&&s.date===e)}markArrival(t,e,s,a=null){let i=this.arrivals.find(h=>h.studentId===t&&h.date===s);if(i)return{success:!1,message:"Already marked",arrival:i};let n=a||new Date().toTimeString().substr(0,5),r=new Date(s).getDay(),d=this.classManager.getScheduleForDay(e,r),o=0,l="on-time";if(d&&d.enabled&&d.startTime){let[h,c]=d.startTime.split(":").map(Number),[w,M]=n.split(":").map(Number),$=h*60+c,I=w*60+M;o=Math.max(0,I-$),l=o>0?"late":"on-time"}let u={id:this.generateId(),studentId:t,classId:e,date:s,time:n,minutesLate:o,status:l,createdAt:new Date().toISOString()};return this.arrivals.push(u),this.save(),{success:!0,arrival:u}}removeArrival(t,e){let s=this.arrivals.findIndex(a=>a.studentId===t&&a.date===e);return s!==-1?(this.arrivals.splice(s,1),this.save(),!0):!1}hasArrived(t,e){return this.arrivals.find(s=>s.studentId===t&&s.date===e)||null}getStudentStats(t,e=null,s=null){let a=this.arrivals.filter(l=>l.studentId===t);e&&(a=a.filter(l=>l.date>=e)),s&&(a=a.filter(l=>l.date<=s));let i=a.length,n=a.filter(l=>l.status==="late").length,r=a.filter(l=>l.status==="on-time").length,d=a.reduce((l,u)=>l+u.minutesLate,0),o=n>0?Math.round(d/n):0;return{totalArrivals:i,onTime:r,tardies:n,totalMinutesLate:d,avgMinutesLate:o}}getClassStats(t,e=null,s=null){let a=this.arrivals.filter(r=>r.classId===t);e&&(a=a.filter(r=>r.date>=e)),s&&(a=a.filter(r=>r.date<=s));let i=a.filter(r=>r.status==="late").length,n=a.filter(r=>r.status==="on-time").length;return{totalArrivals:a.length,onTime:n,tardies:i,latenessRate:a.length>0?Math.round(i/a.length*100):0}}generateId(){return"arr_"+Date.now().toString(36)+Math.random().toString(36).substr(2,5)}};var b=class{constructor(t,e,s){this.storage=t,this.studentManager=e,this.classManager=s}generateMonthlyReport(t,e,s){let a=this.classManager.getById(t);if(!a)return null;let i=this.studentManager.getByClass(t),n=e+"-"+String(s).padStart(2,"0")+"-01",r=new Date(e,s,0).toISOString().split("T")[0],d={classId:t,className:a.name,year:e,month:s,monthName:new Date(e,s-1).toLocaleString("default",{month:"long"}),generatedAt:new Date().toISOString(),students:[]};return i.forEach(o=>{let l=this.storage.get("arrivals",[]).filter(c=>c.studentId===o.id&&c.date>=n&&c.date<=r),u=l.filter(c=>c.status==="late"),h=u.reduce((c,w)=>c+w.minutesLate,0);d.students.push({id:o.id,name:o.name,photoUrl:o.photoUrl,totalDays:l.length,onTime:l.filter(c=>c.status==="on-time").length,tardies:u.length,totalMinutesLate:h,avgMinutesLate:u.length>0?Math.round(h/u.length):0,arrivals:l.map(c=>({date:c.date,time:c.time,minutesLate:c.minutesLate}))})}),d.students.sort((o,l)=>o.name.localeCompare(l.name)),d}generateCSV(t){let e=[];e.push("Rapport de retards - "+t.className+" - "+t.monthName+" "+t.year),e.push(""),e.push("Nom,D√©lais,Retards,Minutes de retard, Moyenne"),t.students.forEach(n=>{e.push(n.name+","+n.totalDays+","+n.tardies+","+n.totalMinutesLate+","+n.avgMinutesLate)});let s=t.students.reduce((n,r)=>n+r.totalDays,0),a=t.students.reduce((n,r)=>n+r.tardies,0),i=t.students.reduce((n,r)=>n+r.totalMinutesLate,0);return e.push(""),e.push("Total,"+s+","+a+","+i+","+(a>0?Math.round(i/a):0)),e.join(`
`)}generateDailySheet(t,e){let s=this.classManager.getById(t);if(!s)return null;let a=this.studentManager.getSortedByName(t),i=this.storage.get("arrivals",[]).filter(n=>n.classId===t&&n.date===e);return{classId:t,className:s.name,date:e,students:a.map(n=>{let r=i.find(d=>d.studentId===n.id);return{id:n.id,name:n.name,photoUrl:n.photoUrl,arrived:!!r,time:r?r.time:null,minutesLate:r?r.minutesLate:0,status:r?r.status:"absent"}})}}exportJSON(){return JSON.stringify(this.storage.exportAll(),null,2)}importJSON(t){try{let e=JSON.parse(t);return this.storage.importAll(e),{success:!0}}catch(e){return{success:!1,error:e.message}}}};var y=class{constructor(t){this.app=t,this.currentClassId=null,this.currentDate=new Date().toISOString().split("T")[0],this.views={}}init(){this.renderApp(),this.setupEventListeners(),this.showClassSelector()}renderApp(){document.getElementById("app").innerHTML=`
            <header class="app-header">
                <h1>üìö Lateness Tracker</h1>
                <div class="header-controls">
                    <input type="date" id="datePicker" value="`+this.currentDate+`">
                    <button id="menuBtn" class="icon-btn">‚ò∞</button>
                </div>
            </header>
            
            <nav id="classNav" class="class-nav"></nav>
            
            <main id="mainContent" class="main-content">
                <div class="welcome-screen">
                    <p>Select a class to start tracking</p>
                </div>
            </main>
            
            <nav id="bottomNav" class="bottom-nav">
                <button class="nav-btn active" data-view="tracker">üëã Arrival</button>
                <button class="nav-btn" data-view="students">üë• Students</button>
                <button class="nav-btn" data-view="schedule">üìÖ Schedule</button>
                <button class="nav-btn" data-view="reports">üìä Reports</button>
            </nav>

            <div id="modal" class="modal hidden"></div>
            <div id="sidebar" class="sidebar hidden"></div>
        `}setupEventListeners(){document.getElementById("datePicker").addEventListener("change",t=>{this.currentDate=t.target.value,this.refreshCurrentView()}),document.getElementById("bottomNav").addEventListener("click",t=>{if(t.target.classList.contains("nav-btn")){let e=t.target.dataset.view;this.switchView(e)}}),document.getElementById("menuBtn").addEventListener("click",()=>{this.toggleSidebar()}),document.getElementById("modal").addEventListener("click",t=>{t.target.id==="modal"&&this.closeModal()})}showClassSelector(){let t=this.app.classManager.getAll(),e=document.getElementById("classNav");if(t.length===0)e.innerHTML='<button class="add-class-btn" onclick="window.app.ui.showAddClassModal()">+ Add Class</button>';else{e.innerHTML=t.map(s=>'<button class="class-btn '+(this.currentClassId===s.id?"active":"")+'" data-class-id="'+s.id+'">'+s.name+"</button>").join(""),document.querySelectorAll(".class-btn").forEach(s=>{s.addEventListener("click",()=>{this.selectClass(s.dataset.classId)})}),this.currentClassId||this.selectClass(t[0].id)}}selectClass(t){this.currentClassId=t,document.querySelectorAll(".class-btn").forEach(e=>{e.classList.toggle("active",e.dataset.classId===t)}),this.refreshCurrentView()}switchView(t){document.querySelectorAll(".nav-btn").forEach(e=>{e.classList.toggle("active",e.dataset.view===t)});let e=document.getElementById("mainContent");switch(t){case"tracker":this.renderTrackerView(e);break;case"students":this.renderStudentsView(e);break;case"schedule":this.renderScheduleView(e);break;case"reports":this.renderReportsView(e)}this.currentView=t}renderTrackerView(e){if(!this.currentClassId){e.innerHTML='<p class="empty-state">Select a class first</p>';return}let s=this.app.studentManager.getSortedByName(this.currentClassId),a=this.app.arrivalTracker.getByClassAndDate(this.currentClassId,this.currentDate),i=this.app.classManager.getById(this.currentClassId),n=new Date(this.currentDate).getDay(),r=this.app.classManager.getScheduleForDay(this.currentClassId,n);e.innerHTML='<div class="tracker-view"><div class="tracker-header"><h2>'+i.name+'</h2><p class="date-display">'+this.formatDate(this.currentDate)+"</p>"+(r&&r.enabled?'<p class="schedule-info">Class: '+r.startTime+" - "+r.endTime+"</p>":'<p class="no-class">No class scheduled</p>')+'</div><div class="students-grid">'+s.map(t=>this.renderStudentCard(t,a.find(s=>s.studentId===t.id))).join("")+'</div><div class="tracker-stats"><span>Present: '+a.length+'</span><span>Absent: '+(s.length-a.length)+"</span></div></div>",e.querySelectorAll(".student-card").forEach(t=>{t.addEventListener("click",()=>{this.toggleArrival(t.dataset.studentId)})})}renderStudentCard(t,e){let s=!!e,a=s?e.status:"absent",i=s?e.minutesLate>0?e.minutesLate+"min late":"On time":"Absent";return'<div class="student-card '+a+'" data-student-id="'+t.id+'"><div class="student-photo">'+(t.photoUrl?'<img src="'+t.photoUrl+'" alt="'+t.name+'">':'<div class="photo-placeholder">üë§</div>')+'</div><div class="student-name">'+t.name+'</div><div class="student-status">'+i+"</div>"+(s?'<div class="arrival-time">'+e.time+"</div>":"")+"</div>"}toggleArrival(t){let e=this.app.arrivalTracker.hasArrived(t,this.currentDate);e?this.app.arrivalTracker.removeArrival(t,this.currentDate):this.app.arrivalTracker.markArrival(t,this.currentClassId,this.currentDate),this.refreshCurrentView()}renderStudentsView(e){if(!this.currentClassId){e.innerHTML='<p class="empty-state">Select a class first</p>';return}let s=this.app.studentManager.getSortedByName(this.currentClassId);e.innerHTML='<div class="students-view"><div class="view-header"><h2>Students - '+this.app.classManager.getById(this.currentClassId).name+'</h2><button class="btn btn-primary" onclick="window.app.ui.showAddStudentModal()">+ Add Student</button></div><div class="import-section"><button class="btn btn-secondary" onclick="window.app.ui.showImportModal()">üì• Import CSV</button></div><ul class="student-list">'+(s.map(t=>'<li class="student-item"><span>'+t.name+'</span><button class="icon-btn danger" onclick="window.app.ui.deleteStudent(\''+t.id+'\')">üóëÔ∏è</button></li>').join(""))+"</ul>"+(s.length===0?'<p class="empty-state">No students yet</p>':"")+"</div>"}renderScheduleView(e){if(!this.currentClassId){e.innerHTML='<p class="empty-state">Select a class first</p>';return}let s=this.app.classManager.getById(this.currentClassId),a=["monday","tuesday","wednesday","thursday","friday","saturday","sunday"],i=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];e.innerHTML='<div class="schedule-view"><h2>Schedule - '+s.name+'</h2><div class="schedule-grid">'+(a.map((t,n)=>{let r=s.schedule[t]||{enabled:!1};return'<div class="schedule-day '+(r.enabled?"enabled":"")+'"><label class="day-name"><input type="checkbox" '+(r.enabled?"checked":"")+' onchange="window.app.ui.toggleDay(\''+t+'\')">'+i[n]+"</label>"+(r.enabled?'<div class="time-inputs"><input type="time" value="'+(r.startTime||"08:00")+'" onchange="window.app.ui.updateSchedule(\''+t+"\', 'startTime', this.value)"><span>to</span><input type="time" value="'+(r.endTime||"12:00")+'" onchange="window.app.ui.updateSchedule(\''+t+"\', 'endTime', this.value)"></div>':'<span class="no-class">No class</span>')+"</div>"}).join(""))+"</div></div>"}renderReportsView(e){let s=this.app.classManager.getById(this.currentClassId),a=new Date,i=Array.from({length:12},(t,n)=>'<option value="'+(n+1)+'" '+(n+1===a.getMonth()+1?"selected":"")+">"+new Date(0,n).toLocaleString("default",{month:"long"})+"</option>").join(""),n=Array.from({length:3},(t,n)=>'<option value="'+(a.getFullYear()-n)+'" '+(n===0?"selected":"")+">"+(a.getFullYear()-n)+"</option>").join("");e.innerHTML='<div class="reports-view"><h2>Reports - '+(s?s.name:"Select Class")+'</h2><div class="report-options"><label>Month:<select id="reportMonth">'+i+"</select></label><label>Year:<select id=\"reportYear\">"+n+'</select></label></div><div class="report-actions"><button class="btn btn-primary" onclick="window.app.ui.generatePDFReport()">üìÑ Generate PDF</button><button class="btn btn-secondary" onclick="window.app.ui.generateCSVReport()">üìä Export CSV</button></div><div id="reportPreview" class="report-preview"></div></div>'}showAddClassModal(){this.showModal("<h2>Add Class</h2><form onsubmit=\"window.app.ui.addClass(event)\"><div class=\"form-group\"><label>Class Name</label><input type=\"text\" name=\"className\" placeholder=\"e.g., 1AEP\" required></div><div class=\"form-actions\"><button type=\"button\" class=\"btn\" onclick=\"window.app.ui.closeModal()\">Cancel</button><button type=\"submit\" class=\"btn btn-primary\">Add</button></div></form>")}addClass(t){t.preventDefault();let e=t.target.className.value;this.app.classManager.add(e),this.showClassSelector(),this.closeModal()}showAddStudentModal(){this.showModal("<h2>Add Student</h2><form onsubmit=\"window.app.ui.addStudent(event)\"><div class=\"form-group\"><label>Name</label><input type=\"text\" name=\"studentName\" placeholder=\"Student name\" required></div><div class=\"form-group\"><label>Photo URL (optional)</label><input type=\"url\" name=\"photoUrl\" placeholder=\"https://...\"></div><div class=\"form-actions\"><button type=\"button\" class=\"btn\" onclick=\"window.app.ui.closeModal()\">Cancel</button><button type=\"submit\" class=\"btn btn-primary\">Add</button></div></form>")}addStudent(t){t.preventDefault();let e=t.target.studentName.value,s=t.target.photoUrl.value||null;this.app.studentManager.add(e,this.currentClassId,s),this.refreshCurrentView(),this.closeModal()}showImportModal(){this.showModal("<h2>Import Students from CSV</h2><p class=\"help-text\">CSV format: name,photoUrl (optional)</p><form onsubmit=\"window.app.ui.importStudents(event)\"><div class=\"form-group\"><textarea name=\"csvContent\" rows=\"10\" placeholder=\"Ahmed\nSara,https://...\nKhalid\" required></textarea></div><div class=\"form-actions\"><button type=\"button\" class=\"btn\" onclick=\"window.app.ui.closeModal()\">Cancel</button><button type=\"submit\" class=\"btn btn-primary\">Import</button></div></form>")}importStudents(t){t.preventDefault();let e=t.target.csvContent.value,s=this.app.studentManager.importFromCSV(e,this.currentClassId);alert("Imported "+s.imported+" students"+(s.errors.length>0?". Errors: "+s.errors.join(", "):"")),this.refreshCurrentView(),this.closeModal()}deleteStudent(t){confirm("Delete this student?")&&(this.app.studentManager.delete(t),this.refreshCurrentView())}toggleDay(t){let e=this.app.classManager.getById(this.currentClassId),s=e.schedule[t]?.enabled||!1;this.app.classManager.update(this.currentClassId,{schedule:{...e.schedule,[t]:s?{enabled:!1}:{enabled:!0,startTime:"08:00",endTime:"12:00"}}}),this.refreshCurrentView()}updateSchedule(t,e,s){let a=this.app.classManager.getById(this.currentClassId);this.app.classManager.update(this.currentClassId,{schedule:{...a.schedule,[t]:{...a.schedule[t],[e]:s}}})}async generatePDFReport(){let t=parseInt(document.getElementById("reportMonth").value),e=parseInt(document.getElementById("reportYear").value),s=this.app.reportGenerator.generateMonthlyReport(this.currentClassId,e,t);if(!s)return;let a=this.generateReportHTML(s),i=window.open("","_blank");i.document.write(a),i.document.close(),i.print()}generateCSVReport(){let t=parseInt(document.getElementById("reportMonth").value),e=parseInt(document.getElementById("reportYear").value),s=this.app.reportGenerator.generateMonthlyReport(this.currentClassId,e,t),a=this.app.reportGenerator.generateCSV(s),i=new Blob([a],{type:"text/csv"}),n=URL.createObjectURL(i),r=document.createElement("a");r.href=n,r.download="rapport_"+s.className+"_"+t+"_"+e+".csv",r.click(),URL.revokeObjectURL(n)}generateReportHTML(t){return'<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Rapport - '+t.className+" - "+t.monthName+'</title><style>body{font-family:Arial,sans-serif;padding:20px}h1{text-align:center}table{width:100%;border-collapse:collapse;margin-top:20px}th,td{border:1px solid #333;padding:8px;text-align:left}th{background:#f0f0f0}.text-center{text-align:center}.text-right{text-align:right}</style></head><body><h1>Rapport de Retards - '+t.className+"</h1><p class=\"text-center\">"+t.monthName+" "+t.year+'</p><table><thead><tr><th>√âl√®ve</th><th class="text-center">Jours</th><th class="text-center">√Ä l\'heure</th><th class="text-center">Retards</th><th class="text-right">Minutes</th><th class="text-right">Moyenne</th></tr></thead><tbody>'+(t.students.map(e=>"<tr><td>"+e.name+"</td><td class=\"text-center\">"+e.totalDays+"</td><td class=\"text-center\">"+e.onTime+"</td><td class=\"text-center\">"+e.tardies+"</td><td class=\"text-right\">"+e.totalMinutesLate+"</td><td class=\"text-right\">"+e.avgMinutesLate+"</td></tr>").join(""))+'</tbody></table><p style="margin-top:20px;text-align:right;">G√©n√©r√© le '+new Date().toLocaleDateString()+"</p></body></html>"}showModal(t){document.getElementById("modal").innerHTML='<div class="modal-content">'+t+"</div>",document.getElementById("modal").classList.remove("hidden")}closeModal(){document.getElementById("modal").classList.add("hidden")}toggleSidebar(){document.getElementById("sidebar").classList.toggle("hidden")}refreshCurrentView(){this.switchView(this.currentView||"tracker")}formatDate(t){let e=new Date(t);return e.toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}}var w=class{constructor(t,e){this.namespace=t,e&&(this.prefix=e)}set(t,e){try{localStorage.setItem(this.namespace+":"+t,JSON.stringify(e));return!0}catch(t){return console.error("Storage error: "+t),!1}}get(t,e=null){try{let s=localStorage.getItem(this.namespace+":"+t);return s?JSON.parse(s):e}catch(t){return console.error("Storage read error: "+t),e}}remove(t){localStorage.removeItem(this.namespace+":"+t)}exportAll(){let t={};for(let e=0;e<localStorage.length;e++){let s=localStorage.key(e);s.startsWith(this.namespace+":")&&(t[s.replace(this.namespace+":","")]=this.get(s.replace(this.namespace+":","")))}return t}importAll(t){Object.entries(t).forEach(([e,s])=>{this.set(e,s)})}clearAll(){let t=[];for(let e=0;e<localStorage.length;e++){let s=localStorage.key(e);s.startsWith(this.namespace+":")&&t.push(s)}t.forEach(t=>localStorage.removeItem(t))}};var S=new w("lateness-tracker"),c=new m(S),d=new g(S),o=new v(S,c),M=new b(S,d,c),u=new y;async function init(){console.log("üì± Lateness Tracker starting..."),await c.load(),await d.load(),await o.load(),u.init(),console.log("‚úÖ App initialized")}document.addEventListener("DOMContentLoaded",()=>{init()}),window.app={storage:S,classManager:c,studentManager:d,arrivalTracker:o,reportGenerator:M,ui:u}})();
    </script>
</body>
</html>
